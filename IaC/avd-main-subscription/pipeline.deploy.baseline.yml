name: 'AVD Main Subscription - Baseline Deployment Pipeline'

parameters:
- name: environment
  displayName: 'Environment to deploy to'
  type: string
  default: 'canary'
  values:
  - canary
  - production

variables:
- group: AVD-Variable-Group
- template: pipeline.variables.tst.yml

# Environment specific details
- ${{ if eq(parameters.environment, 'canary') }}:
  # - name: poolName
  #   value: ''
  - name: serviceConnection
    value: '<service_connection>' ## change for each subscription
  - name: devOpsPipelineEnvironment
    value: 'AVD-Canary'

- ${{ if eq(parameters.environment, 'production') }}:
  # - name: poolName
  #   value: ''
  - name: serviceConnection
    value: '<service_connection>' ## change for each subscription
  - name: devOpsPipelineEnvironment
    value: 'AVD-Production'

# pool:
#   name: $(poolName)

trigger: none

stages:
- stage: Validation
  condition: succeeded()
  jobs:
  - job: Template_Validation
    displayName: 'Baseline Validation - ${{ parameters.environment }}'
    steps:
    - task: AzureCLI@2
      inputs:
        azureSubscription: '$(serviceConnection)'
        scriptType: bash
        scriptLocation: inlineScript
        useGlobalConfig: false
        inlineScript: |
          az --version
          az deployment sub what-if \
            --location $(location) \
            --template-file $(System.DefaultWorkingDirectory)/$(templatePath) \
            --parameters $(System.DefaultWorkingDirectory)/$(parametersPath) \
            --parameters avdVmLocalUserPassword="$(avdVmLocalUserPassword)"

- stage: Deployment
  dependsOn:
  - Validation
  condition: succeeded('Validation')
  jobs:
  - deployment: Template_Deployment
    displayName: 'Baseline deployment - ${{ parameters.environment }}'
    environment: $(devOpsPipelineEnvironment)
    strategy:
      runOnce:
        deploy:
          steps:
          - checkout: self
          - task: AzureCLI@2
            inputs:
              environment: '$(devOpsPipelineEnvironment)'
              azureSubscription: '$(serviceConnection)'
              scriptType: bash
              scriptLocation: inlineScript
              useGlobalConfig: false
              workingDirectory: '$(System.DefaultWorkingDirectory)'
              inlineScript: |
                az deployment sub create \
                  --location $(location) \
                  --template-file $(System.DefaultWorkingDirectory)/$(templatePath) \
                  --parameters $(System.DefaultWorkingDirectory)/$(parametersPath) \
                  --parameters avdVmLocalUserPassword="$(avdVmLocalUserPassword)"
