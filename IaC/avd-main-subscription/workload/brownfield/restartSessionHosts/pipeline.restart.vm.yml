name: 'subcr-avd-tst-001'

parameters:
- name: environment
  displayName: 'Environment to deploy to'
  type: string
  default: 'test'
  values:
  - test
  - integration

variables:

# Environment specific variable files
- ${{ if eq(parameters.environment, 'test') }}:
  - template: pipeline.variables.tst.yml

- ${{ if eq(parameters.environment, 'integration') }}:
  - template: pipeline.variables.integration.yml

pool:
  name: $(poolName)

trigger: none

stages:
- stage: Validation
  condition: succeeded()
  jobs:
  - deployment: Template_Validation
    displayName: 'Validation - ${{ parameters.environment }}'
    environment: $(devOpsPipelineEnvironment)
    strategy:
      runOnce:
        deploy:
          steps:
          - checkout: self
          - task: AzureCLI@2
            inputs:
              environment: '$(devOpsPipelineEnvironment)'
              azureSubscription: '$(serviceConnection)'
              scriptType: bash
              scriptLocation: inlineScript
              useGlobalConfig: false
              workingDirectory: '$(System.DefaultWorkingDirectory)'
              inlineScript: |
                az deployment sub what-if \
                  --location $(location) \
                  --template-file $(System.DefaultWorkingDirectory)/$(templatePath) \
                  --parameters $(System.DefaultWorkingDirectory)/$(parametersPath)

- stage: Restart
  dependsOn: Validation
  condition: succeeded('Validation')
  jobs:
  - deployment: Template_Execution
    displayName: 'Restart Initiation - ${{ parameters.environment }} '
    environment: $(devOpsPipelineEnvironment)
    strategy:
      runOnce:
        deploy:
          steps:
          - checkout: self
          - task: AzureCLI@2
            inputs:
              environment: '$(devOpsPipelineEnvironment)'
              azureSubscription: '$(serviceConnection)'
              scriptType: bash
              scriptLocation: inlineScript
              useGlobalConfig: false
              workingDirectory: '$(System.DefaultWorkingDirectory)'
              inlineScript: |
                az deployment sub create \
                  --location $(location) \
                  --template-file $(System.DefaultWorkingDirectory)/$(templatePath) \
                  --parameters $(System.DefaultWorkingDirectory)/$(parametersPath)
                  